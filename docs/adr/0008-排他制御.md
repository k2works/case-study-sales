# 8. 排他制御

データベースの排他制御についての方針を決定する。

日付: 2024-12-05

## ステータス

2024-12-05 提案されました

## コンテキスト

[MyBatisを使用した排他制御](https://terasolunaorg.github.io/guideline/public_review/ArchitectureInDetail/ExclusionControl.html#mybatis)には、以下の方法がある。

 **行ロック**

- **メリット**:
    - データベースが提供するネイティブなロック機能を活用でき、直感的で実装が簡単。
    - ロック中のデータにアクセスしようとする他のトランザクションを自動的に待機させることができる。

- **デメリット**:
    - データベースへのロックを取得するために、処理のパフォーマンスが低下する場合がある。
    - 高い排他制御が要求されるため、スケーラビリティの面での制約がある。

**悲観ロック**

- **メリット**:
    - データ競合を事前に防ぐため、データの整合性を非常に高いレベルで維持できる。
    - データに対する独占的なアクセスを保証。

- **デメリット**:
    - 長期間のロックはデッドロックを引き起こしやすく、システムのスループットを低下させる可能性がある。
    - ロックの実装と管理が複雑になることがある。

**楽観ロック**

- **メリット**:
    - 実際のロックを避けるため、並列処理のパフォーマンスが向上。
    - 競合が発生した場合にのみ回避策を取るため、スケーラビリティに優れている。

- **デメリット**:
    - データ更新時に競合が発生すると、そのトランザクションを再試行する必要があり、これが頻発するとパフォーマンスに影響を与える可能性がある。
    - 競合を検出するために追加のデータ管理（バージョン番号やタイムスタンプ）が必要。

## 決定

スケーラビリティを考慮し、楽観ロックを採用する。

## 影響

ポジティブ:
- 将来マイクロサービスアーキテクチャ採用において、スケーラビリティを確保できる

ネガティブ:
- 既存データベースに楽観ロックを導入するための変更が必要

## コプライアンス

単体テストを実施し、楽観ロックが正しく機能することを確認する。

## 備考

- 著者: k2works
- バージョン: 0.1
- 変更ログ:
    - 0.1: 初回提案バージョン
