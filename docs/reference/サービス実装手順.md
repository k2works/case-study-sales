```plantuml
@startmindmap
* サービス層
-- サービス実装
--- SalesService
-- テスト
--- SalesServiceTest
@endmindmap
```

## サービス実装手順

売上管理機能のサービス部分は、以下の手順で実装されました。各ステップは特定の責務を持つコンポーネントを追加し、全体として堅牢なサービス層を構築しています。

## 実装ステップ

以下は実装ステップの状態遷移を示すステートチャートです：

```plantuml
@startuml
[*] --> サービス実装
サービス実装 --> テスト実装
テスト実装 --> [*]

state サービス実装 {
  [*] --> リポジトリ連携
  リポジトリ連携 --> ビジネスロジック実装
  ビジネスロジック実装 --> バリデーション実装
  バリデーション実装 --> [*]
}

state テスト実装 {
  [*] --> テストデータ準備
  テストデータ準備 --> 単体テスト実装
  単体テスト実装 --> [*]
}
@enduml
```

### 2. サービス実装

次に、サービスインター実装クラスを作成します。このクラスはリポジトリを使用してデータアクセスを行い、ビジネスロジックを実行します。

```plantuml
@startuml
package "サービス実装" {
  class SalesService {
    -salesRepository: SalesRepository
    +findById(String): SalesResource
    +findAll(int, int): SalesListResource
    +findByCriteria(SalesCriteriaResource, int, int): SalesListResource
    +register(SalesResource): SalesResource
    +update(SalesResource): SalesResource
    +delete(String): void
    -validateSales(SalesResource): void
  }
}

package "リポジトリ" {
  interface SalesRepository
}

SalesService --> SalesRepository
@enduml
```

### 4. テスト実装

最後に、サービス層のテストを実装します。これにより、サービス層の機能が正しく動作することを確認できます。

```plantuml
@startuml
package "テスト" {
  class SalesServiceTest {
    -salesService: SalesService
    -salesRepository: SalesRepository
    -testDataFactory: TestDataFactory
    +setUp(): void
    +tearDown(): void
    +testFindById_存在する場合(): void
    +testFindById_存在しない場合(): void
    +testFindAll(): void
    +testFindByCriteria(): void
    +testRegister(): void
    +testUpdate(): void
    +testDelete(): void
  }
  
  class TestDataFactory {
    +createSalesResource(): SalesResource
    +createSalesLineResource(SalesResource): SalesLineResource
    +createSalesCriteriaResource(): SalesCriteriaResource
  }
  
  SalesServiceTest ..> TestDataFactory
}

package "サービスインターフェース" {
  interface SalesService
}

package "リポジトリ" {
  interface SalesRepository
}

SalesServiceTest --> SalesService
SalesServiceTest --> SalesRepository
@enduml
```

## サービス実装のポイント

1. **レイヤー分離**: サービス層はアプリケーション層とドメイン層の間の橋渡しをし、各層の責務を明確に分離しています。
2. **例外処理**: 適切な例外クラスを定義し、エラー状況を明確に伝えています。
3. **テスト駆動開発**: サービス層の機能を検証するテストケースを実装しています。

## テスト戦略

サービス層のテストは、以下の方針で実施されています：

```plantuml
@startuml
package "テスト戦略" {
  class "正常系テスト" as NormalTest {
    +データ取得テスト
    +データ登録テスト
    +データ更新テスト
    +データ削除テスト
  }
  
  class "異常系テスト" as AbnormalTest {
    +存在しないIDでの検索テスト
    +バリデーションエラーテスト
    +重複データ登録テスト
  }
  
  class "境界値テスト" as BoundaryTest {
    +ページングの境界値テスト
    +日付範囲の境界値テスト
  }
  
  NormalTest --|> "テスト戦略"
  AbnormalTest --|> "テスト戦略"
  BoundaryTest --|> "テスト戦略"
}
@enduml
```

### テスト実装のポイント

1. **モック利用**: リポジトリをモック化し、サービス層のロジックのみをテストしています。
2. **テストデータファクトリ**: テストデータの作成を一元管理し、テストコードの可読性と保守性を向上させています。
3. **CRUD操作の網羅**: 全てのサービス操作（検索、登録、更新、削除）に対するテストを実装しています。
4. **エッジケースのテスト**: 存在しないIDでの検索や、バリデーションエラーなど、エラーケースも適切にテストしています。

## 実装手順のまとめ

売上管理機能のサービス部分の実装は、以下の4つのステップで行われました：

1. **サービス実装**: リポジトリを使用したサービスインターフェースの実装
2. **テスト実装**: サービス層の機能を検証するテストケースの作成

この実装アプローチにより、保守性が高く、拡張性のあるサービス層が実現されています。
